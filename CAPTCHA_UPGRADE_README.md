# 验证码识别系统升级说明

## 🚀 升级概述

本项目已经成功集成了改进的 OCR 验证码识别系统，能够自动识别和点击汉字验证码，大大提高了爬虫的自动化程度。

## ✨ 主要改进

### 1. 智能 OCR 识别

- **使用 EasyOCR 引擎**：支持中文和英文识别
- **图像预处理优化**：对比度增强、锐度提升、去噪处理
- **智能汉字匹配**：支持相似字符识别和模糊匹配

### 2. 验证码处理流程

- **自动检测验证码**：多种选择器策略，提高检测成功率
- **指令智能解析**：支持多种验证码指令格式
- **精确点击执行**：坐标验证和范围检查
- **自动登录检测**：智能等待和状态检查

### 3. 容错和调试

- **多重重试机制**：最多 5 次验证码处理尝试
- **调试图片保存**：自动保存验证码图片用于分析
- **详细日志记录**：每个步骤都有详细的执行日志
- **手动模式兜底**：OCR 失败时自动切换到手动模式

## 📦 依赖安装

### 必需依赖

```bash
# 基础依赖（已安装）
pip install opencv-python-headless
pip install pillow
pip install numpy

# OCR引擎（新增加）
pip install easyocr
```

### 可选依赖（GPU 加速）

```bash
pip install torch torchvision
```

## 🔧 使用方法

### 1. 默认模式（推荐）

```bash
python main.py
```

- 自动使用改进的 OCR 识别器
- 如果 OCR 不可用，自动切换到手动模式

### 2. 明确使用 OCR

```bash
python main.py --use-solver ocr
```

- 强制使用 OCR 识别器
- 如果依赖缺失会提示安装

### 3. 限制抓取数量

```bash
python main.py --limit 100
```

- 只抓取前 100 个课程，适合测试

### 4. 手动登录模式

```bash
python main.py --login-manual
```

- 手动完成一次登录，保存会话状态

## 🎯 验证码识别流程

### 1. 检测阶段

```
页面加载 → 查找验证码图片 → 获取验证码指令
```

### 2. 识别阶段

```
图像预处理 → OCR文字识别 → 汉字匹配 → 生成点击坐标
```

### 3. 执行阶段

```
坐标验证 → 依次点击 → 等待验证 → 检查登录状态
```

## 🔍 调试功能

### 1. 验证码图片保存

- 每次验证码处理都会保存图片
- 文件名格式：`captcha_debug_{尝试次数}.png`
- 便于分析识别问题

### 2. 详细日志输出

```python
# 示例日志
2024-01-01 12:00:00 | INFO | 开始处理验证码 (尝试 1/5)
2024-01-01 12:00:01 | INFO | 从base64获取验证码图片数据
2024-01-01 12:00:02 | INFO | 需要点击的汉字: ['建', '机', '后']
2024-01-01 12:00:03 | INFO | OCR识别到的文字: ['建', '机', '后', '前', '左']
2024-01-01 12:00:04 | INFO | 成功匹配到 3 个点击点
```

### 3. 手动模式切换

- 当 OCR 识别失败时，自动提示切换到手动模式
- 手动完成验证码后，脚本自动检测登录状态

## ⚠️ 常见问题

### 1. EasyOCR 首次使用缓慢

**问题**：首次运行时需要下载中文模型
**解决**：耐心等待，或使用国内镜像源

### 2. 识别准确率不高

**问题**：验证码图片质量差或干扰多
**解决**：

- 检查保存的调试图片
- 调整图像预处理参数
- 增加相似字符字典

### 3. 点击位置不准确

**问题**：坐标计算或边界框获取有误
**解决**：

- 检查验证码图片边界框
- 验证相对坐标到绝对坐标的转换
- 确认点击范围检查逻辑

### 4. 网络连接问题

**问题**：无法下载 EasyOCR 模型
**解决**：

- 检查网络代理设置
- 使用国内镜像源
- 手动下载模型文件

## 🚀 性能优化建议

### 1. 模型缓存

- EasyOCR 模型加载较慢，建议复用实例
- 避免频繁创建和销毁识别器

### 2. 图片处理

- 过大的验证码图片可以适当压缩
- 根据实际需求调整预处理参数

### 3. 并发控制

- 避免同时处理多个验证码
- 合理设置超时时间

## 📝 配置选项

### 1. 环境变量

```bash
# 验证码识别器选择
export CAPTCHA_SOLVER=ocr  # 或 ruokuai

# 调试模式
export DEBUG_CAPTCHA=true
export SAVE_CAPTCHA_IMAGES=true
```

### 2. 配置文件

在 `config.py` 中可以设置：

- 验证码处理超时时间
- 重试次数
- 图片保存路径

## 🔮 未来改进方向

### 1. 机器学习增强

- 训练专门的验证码识别模型
- 支持更多验证码类型

### 2. 云端识别服务

- 集成多个在线识别服务
- 智能选择最佳服务

### 3. 用户界面

- 添加验证码识别结果预览
- 支持手动调整点击位置

## 📞 技术支持

如果遇到问题，请：

1. **查看日志**：检查详细的执行日志
2. **保存图片**：分析保存的验证码图片
3. **检查依赖**：确认所有依赖都已正确安装
4. **提交 Issue**：在项目仓库中描述问题

## 🎉 总结

新的验证码识别系统大大提升了爬虫的自动化程度，主要优势：

- ✅ **高识别准确率**：使用先进的 OCR 技术
- ✅ **智能容错机制**：多重保障，确保稳定运行
- ✅ **详细调试信息**：便于问题分析和优化
- ✅ **向后兼容**：不影响现有功能
- ✅ **易于扩展**：支持添加新的识别策略

现在你可以享受更智能、更稳定的验证码自动识别体验！

